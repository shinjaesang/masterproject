<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="orderMapper">
	<resultMap id="orderResultMap" type="Order">
		<result property="orderId" column="ORDER_ID" />
		<result property="partnerId" column="PARTNER_ID" />
		<result property="partnerName" column="PARTNER_NAME" />
		<result property="partnerType" column="PARTNER_TYPE" />
		<result property="managerName" column="MANAGER_NAME" />
		<result property="contactInfo" column="CONTACT_INFO" />
		<result property="partnerAddress" column="PARTNER_ADDRESS" />
		<result property="productId" column="PRODUCT_ID" />
		<result property="productName" column="PRODUCT_NAME" />
		<result property="optionValue" column="OPTION_VALUE" />
		<result property="sellingPrice" column="SELLING_PRICE" />
		<result property="quantity" column="QUANTITY" />
		<result property="orderType" column="ORDER_TYPE" />
		<result property="orderStatus" column="ORDER_STATUS" />
		<result property="createdAt" column="CREATED_AT" />
	</resultMap>
	<!-- 주문 목록 조회 -->
	<select id="selectOrderList" resultMap="orderResultMap">
		SELECT 
			o.ORDER_ID, o.PARTNER_ID, p.PARTNER_NAME, p.PARTNER_TYPE, p.MANAGER_NAME, p.CONTACT_INFO, p.PARTNER_ADDRESS,
			o.PRODUCT_ID, pr.PRODUCT_NAME, pr.OPTION_VALUE, pr.SELLING_PRICE, o.QUANTITY, o.ORDER_TYPE, o.ORDER_STATUS, o.CREATED_AT
		FROM 
			TB_ORDERS o
			LEFT JOIN TB_PARTNER p ON o.PARTNER_ID = p.PARTNER_ID
			LEFT JOIN TB_PRODUCT pr ON o.PRODUCT_ID = pr.PRODUCT_ID
		<where>
			<if test="orderId != null and orderId != ''">
				AND o.ORDER_ID LIKE '%' || #{orderId} || '%'
			</if>
			<if test="partnerId != null and partnerId != ''">
				AND o.PARTNER_ID = #{partnerId}
			</if>
			<if test="partnerName != null and partnerName != ''">
				AND p.PARTNER_NAME LIKE '%' || #{partnerName} || '%'
			</if>
			<if test="orderType != null and orderType != ''">
				AND o.ORDER_TYPE = #{orderType}
			</if>
			<if test="orderStatus != null and orderStatus != ''">
				AND o.ORDER_STATUS = #{orderStatus}
			</if>
			<if test="startDate != null and startDate != ''">
				AND o.CREATED_AT >= TO_DATE(#{startDate}, 'YYYY-MM-DD')
			</if>
			<if test="endDate != null and endDate != ''">
				AND o.CREATED_AT &lt;= TO_DATE(#{endDate}, 'YYYY-MM-DD')
			</if>
			<if test="productName != null and productName != ''">
				AND pr.PRODUCT_NAME LIKE '%' || #{productName} || '%'
			</if>
			<if test="minPrice != null">
				AND pr.SELLING_PRICE >= #{minPrice}
			</if>
			<if test="maxPrice != null">
				AND pr.SELLING_PRICE &lt;= #{maxPrice}
			</if>
		</where>
		ORDER BY o.CREATED_AT DESC
	</select>
	<!-- 주문 상세 조회 -->
	<select id="selectOrderById" parameterType="string" resultMap="orderResultMap">
		SELECT 
			o.ORDER_ID, o.PARTNER_ID, p.PARTNER_NAME, p.PARTNER_TYPE, p.MANAGER_NAME, p.CONTACT_INFO, p.PARTNER_ADDRESS,
			o.PRODUCT_ID, pr.PRODUCT_NAME, pr.OPTION_VALUE, pr.SELLING_PRICE, o.QUANTITY, o.ORDER_TYPE, o.ORDER_STATUS, o.CREATED_AT
		FROM 
			TB_ORDERS o
			LEFT JOIN TB_PARTNER p ON o.PARTNER_ID = p.PARTNER_ID
			LEFT JOIN TB_PRODUCT pr ON o.PRODUCT_ID = pr.PRODUCT_ID
		WHERE 
			o.ORDER_ID = #{orderId}
	</select>
	<!-- 주문 등록 -->
	<insert id="insertOrder" parameterType="Order">
		INSERT INTO TB_ORDERS (
			ORDER_ID, PARTNER_ID, PRODUCT_ID, QUANTITY, ORDER_TYPE, ORDER_STATUS, CREATED_AT
		) VALUES (
			'ORD' || LPAD(SEQ_ORDERS.NEXTVAL, 3, '0'), #{partnerId}, #{productId},
			#{quantity}, #{orderType}, '접수', SYSDATE
		)
	</insert>
	<!-- 주문 수정 -->
	<update id="updateOrder" parameterType="Order">
		UPDATE TB_ORDERS 
		SET 
			PARTNER_ID = #{partnerId},
			PRODUCT_ID = #{productId},
			QUANTITY = #{quantity},
			ORDER_TYPE = #{orderType},
			ORDER_STATUS = #{orderStatus}
		WHERE 
			ORDER_ID = #{orderId}
	</update>
	<!-- 주문 삭제 -->
	<delete id="deleteOrder" parameterType="string">
		DELETE FROM TB_ORDERS
		WHERE ORDER_ID = #{orderId}
	</delete>
	<!-- 주문 상태 변경 -->
	<update id="updateOrderStatus">
		UPDATE TB_ORDERS 
		SET ORDER_STATUS = #{orderStatus}
		WHERE ORDER_ID = #{orderId}
	</update>
	<!-- 주문 수량 조회 -->
	<select id="selectOrderCount" parameterType="java.util.Map" resultType="int">
		SELECT COUNT(*) 
		FROM TB_ORDERS o
		LEFT JOIN TB_PARTNER p ON o.PARTNER_ID = p.PARTNER_ID
		LEFT JOIN TB_PRODUCT pr ON o.PRODUCT_ID = pr.PRODUCT_ID
		<where>
			<if test="orderId != null and orderId != ''">
				AND o.ORDER_ID LIKE '%' || #{orderId} || '%'
			</if>
			<if test="partnerName != null and partnerName != ''">
				AND p.PARTNER_NAME LIKE '%' || #{partnerName} || '%'
			</if>
			<if test="partnerType != null and partnerType != ''">
				AND p.PARTNER_TYPE = #{partnerType}
			</if>
			<if test="orderType != null and orderType != ''">
				AND o.ORDER_TYPE = #{orderType}
			</if>
			<if test="orderStatus != null and orderStatus != ''">
				AND o.ORDER_STATUS = #{orderStatus}
			</if>
			<if test="startDate != null and startDate != ''">
				AND o.CREATED_AT >= TO_DATE(#{startDate}, 'YYYY-MM-DD')
			</if>
			<if test="endDate != null and endDate != ''">
				AND o.CREATED_AT &lt;= TO_DATE(#{endDate}, 'YYYY-MM-DD')
			</if>
			<if test="productName != null and productName != ''">
				AND pr.PRODUCT_NAME LIKE '%' || #{productName} || '%'
			</if>
			<if test="minPrice != null">
				AND pr.SELLING_PRICE >= #{minPrice}
			</if>
			<if test="maxPrice != null">
				AND pr.SELLING_PRICE &lt;= #{maxPrice}
			</if>
		</where>
	</select>
	<!-- 상품 정보 조회 -->
	<select id="selectProductInfo" parameterType="string" resultType="Product">
		SELECT 
			PRODUCT_ID as productId,
			PRODUCT_NAME as productName,
			OPTION_VALUE as optionValue,
			SELLING_PRICE as sellingPrice
		FROM TB_PRODUCT
		WHERE PRODUCT_ID = #{productId}
	</select>
	<!-- 거래처 목록 조회 -->
	<select id="selectPartnerList" resultType="Partner">
		SELECT 
			PARTNER_ID as partnerId,
			PARTNER_NAME as partnerName,
			PARTNER_TYPE as partnerType,
			MANAGER_NAME as managerName,
			CONTACT_INFO as contactInfo,
			PARTNER_ADDRESS as partnerAddress
		FROM TB_PARTNER
		ORDER BY PARTNER_NAME
	</select>
	<!-- 선택된 주문 삭제 -->
	<delete id="deleteSelectedOrders" parameterType="java.util.List">
		DELETE FROM TB_ORDERS
		WHERE ORDER_ID IN
		<foreach collection="list" item="orderId" open="(" separator="," close=")">
			#{orderId}
		</foreach>
	</delete>
</mapper>